name: Firmware CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [ F072, F303 ]

    env:
      TARGET: ${{ matrix.target }}
      APT_PACKAGES: "gcc-arm-none-eabi libnewlib-arm-none-eabi dfu-util ccache python3"
      CCACHE_DIR: ~/.ccache
      CCACHE_MAXSIZE: 500M
      OS_NAME: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install toolchain and utils
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends ${APT_PACKAGES}
          arm-none-eabi-gcc --version || true
          ccache --version || true

      - name: Enable ccache
        shell: bash
        run: |
          echo "CC=ccache arm-none-eabi-gcc" >> $GITHUB_ENV
          echo "LD=ccache arm-none-eabi-ld"   >> $GITHUB_ENV
          echo "AR=ccache arm-none-eabi-ar"   >> $GITHUB_ENV
          echo "NM=ccache arm-none-eabi-nm"   >> $GITHUB_ENV
          echo "OBJCOPY=arm-none-eabi-objcopy" >> $GITHUB_ENV
          echo "OBJDUMP=arm-none-eabi-objdump" >> $GITHUB_ENV
          echo "STRIP=arm-none-eabi-strip"     >> $GITHUB_ENV

      - name: Prepare cache dirs
        shell: bash
        run: |
          mkdir -p "${CCACHE_DIR}"
          mkdir -p build

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ env.OS_NAME }}-${{ matrix.target }}-${{ hashFiles('**/*.[chS]', '**/*.ld', 'Makefile*', 'tools/**', 'boards/**', 'include/**', 'src/**') }}
          restore-keys: |
            ccache-${{ env.OS_NAME }}-${{ matrix.target }}-
            ccache-${{ env.OS_NAME }}-

      - name: Configure ccache
        shell: bash
        run: |
          ccache --set-config=cache_dir="${CCACHE_DIR}"
          ccache --set-config=max_size="${CCACHE_MAXSIZE}"
          ccache --set-config=compression=true
          ccache -z

      - name: Cache build directory
        uses: actions/cache@v4
        with:
          path: build/
          key: build-${{ env.OS_NAME }}-${{ matrix.target }}-${{ hashFiles('Makefile*', 'config/**', 'boards/**', 'include/**', 'src/**', 'tools/**') }}
          restore-keys: |
            build-${{ env.OS_NAME }}-${{ matrix.target }}-
            build-${{ env.OS_NAME }}-

      - name: Build firmware
        env:
          TARGET: ${{ matrix.target }}
        shell: bash
        run: |
          if [[ "${CLEAN:-0}" == "1" ]]; then make clean; fi
          make -j"$(nproc)"
          ccache -s

      - name: Determine project name
        id: project
        shell: bash
        run: |
          if [[ "${{ matrix.target }}" == "F303" ]]; then
            echo "name=H4" >> "$GITHUB_OUTPUT"
            echo "dfuse_preset=stm32f303xc" >> "$GITHUB_OUTPUT"
          else
            echo "name=H"  >> "$GITHUB_OUTPUT"
            echo "dfuse_preset=stm32f072xb" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate DFU if script exists
        shell: bash
        run: |
          set -euo pipefail
          proj="${{ steps.project.outputs.name }}"
          if [[ -f "tools/makedfu.py" ]]; then
            python3 tools/makedfu.py "build/${proj}.bin" "build/${proj}.dfu" --preset-target "${{ steps.project.outputs.dfuse_preset }}" --device-id 0x0000
            command -v dfu-suffix >/dev/null 2>&1 && dfu-suffix --check "build/${proj}.dfu" || true
          else
            echo "tools/makedfu.py not found, skipping DFU generation"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: NanoVNA-X-${{ matrix.target }}
          if-no-files-found: error
          path: |
            build/${{ steps.project.outputs.name }}.bin
            build/${{ steps.project.outputs.name }}.hex
            build/${{ steps.project.outputs.name }}.dfu

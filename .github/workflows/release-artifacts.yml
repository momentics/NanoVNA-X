name: Release firmware

on:
  release:
    types: [published]

jobs:
  build-and-upload:
    name: Release ${{ matrix.target }}
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    strategy:
      matrix:
        target: [F072, F303]
      fail-fast: false
    env:
      TARGET: ${{ matrix.target }}
      OSNAME: ubuntu-24.04
      # APT user-cache
      APTUSERCACHE: ${{ github.workspace }}/.apt
      APTUSERARCHIVES: ${{ github.workspace }}/.apt/archives
      APTUSERLISTS: ${{ github.workspace }}/.apt/lists
      # ccache
      CCACHEDIR: .ccache
      CCACHEMAXSIZE: 500M

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # Restore APT cache
      - name: Restore APT user cache
        id: apt-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            .apt/archives
            .apt/lists
          key: apt-${{ env.OSNAME }}-${{ matrix.target }}-${{ hashFiles('.github/workflows/**','Makefile') }}-gcc-arm-none-eabi-libnewlib-arm-none-eabi-dfu-util-ccache-python3
          restore-keys: |
            apt-${{ env.OSNAME }}-${{ matrix.target }}-

      - name: Prime APT from user cache
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${APTUSERARCHIVES}/partial" "${APTUSERLISTS}/partial"
          sudo mkdir -p /var/cache/apt/archives /var/lib/apt/lists
          if [ -d "${APTUSERLISTS}" ]; then
            sudo rsync -a --delete --exclude 'lock' --exclude 'partial' "${APTUSERLISTS}/" /var/lib/apt/lists/
          fi
          if [ -d "${APTUSERARCHIVES}" ]; then
            sudo rsync -a --exclude 'lock' --exclude 'partial' "${APTUSERARCHIVES}/" /var/cache/apt/archives/
          fi

      # INSTALL toolchain + dfu-util + ccache (фикс: добавить ccache)
      - name: Install ARM toolchain and ccache
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get -o Dir::Cache::archives="${APTUSERARCHIVES}" \
                       -o Dir::State::lists="${APTUSERLISTS}" \
                       -o Acquire::Retries=3 update
          sudo apt-get -y --no-install-recommends \
                       -o Dir::Cache::archives="${APTUSERARCHIVES}" \
                       -o Dir::State::lists="${APTUSERLISTS}" \
                       install gcc-arm-none-eabi libnewlib-arm-none-eabi dfu-util ccache python3
          arm-none-eabi-gcc --version || true
          ccache --version || true

      - name: Persist APT user cache back
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${APTUSERARCHIVES}" "${APTUSERLISTS}"
          sudo rsync -a --delete --exclude 'lock' --exclude 'partial' /var/lib/apt/lists/ "${APTUSERLISTS}/"
          sudo rsync -a --exclude 'lock' --exclude 'partial' /var/cache/apt/archives/ "${APTUSERARCHIVES}/"
          sudo chown -R "$(id -u)":"$(id -g)" "${APTUSERCACHE}"

      - name: Save APT user cache (unique key)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .apt/archives
            .apt/lists
          key: apt-${{ env.OSNAME }}-${{ matrix.target }}-${{ hashFiles('.github/workflows/**','Makefile') }}-gcc-arm-none-eabi-libnewlib-arm-none-eabi-dfu-util-ccache-python3-${{ github.run_id }}-${{ github.run_attempt }}

      - name: Prepare cache dirs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${CCACHEDIR}"
          mkdir -p build

      - name: Detect ARM GCC version
        id: gccver
        shell: bash
        run: |
          set -euo pipefail
          ver="$(arm-none-eabi-gcc -dumpversion 2>/dev/null || echo unknown)"
          echo "ver=${ver}" >> "$GITHUB_OUTPUT"
          echo "ARMGCCVER=${ver}" >> "$GITHUB_ENV"

      - name: Restore ccache
        id: ccache-restore
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.CCACHEDIR }}
          key: ccache-${{ env.OSNAME }}-${{ matrix.target }}-${{ steps.gccver.outputs.ver }}-${{ hashFiles('Makefile','config/**','boards/**','include/**','src/**','tools/**') }}
          restore-keys: |
            ccache-${{ env.OSNAME }}-${{ matrix.target }}-${{ steps.gccver.outputs.ver }}-

      - name: Configure ccache and toolchain env
        shell: bash
        run: |
          set -euo pipefail
          ccache --set-config=cache_dir="${CCACHEDIR}"
          ccache --set-config=max_size="${CCACHEMAXSIZE}"
          ccache --set-config=compression=true || true
          ccache -p || true
          {
            echo 'CC=ccache arm-none-eabi-gcc'
            echo 'CXX=ccache arm-none-eabi-g++'
            echo 'AR=arm-none-eabi-ar'
            echo 'NM=arm-none-eabi-nm'
            echo 'OBJCOPY=arm-none-eabi-objcopy'
            echo 'OBJDUMP=arm-none-eabi-objdump'
            echo 'STRIP=arm-none-eabi-strip'
            echo 'CFLAGS_EXTRA=-fdebug-prefix-map=${GITHUB_WORKSPACE}=workspace -ffile-prefix-map=${GITHUB_WORKSPACE}=workspace'
            echo 'CPPFLAGS_EXTRA=-fdebug-prefix-map=${GITHUB_WORKSPACE}=workspace -ffile-prefix-map=${GITHUB_WORKSPACE}=workspace'
          } >> "$GITHUB_ENV"

      - name: Restore build cache
        id: build-restore
        uses: actions/cache/restore@v4
        with:
          path: build
          key: build-${{ env.OSNAME }}-${{ matrix.target }}-${{ steps.gccver.outputs.ver }}-${{ hashFiles('Makefile','config/**','boards/**','include/**','src/**','tools/**') }}
          restore-keys: |
            build-${{ env.OSNAME }}-${{ matrix.target }}-${{ steps.gccver.outputs.ver }}-

      - name: Determine firmware version
        id: version
        run: |
          set -euo pipefail
          fw_version=$(make -s print-version)
          if ! printf '%s' "$fw_version" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$'; then
            echo "Firmware version '$fw_version' is not semantic" >&2
            exit 1
          fi
          tag='${{ github.event.release.tag_name }}'
          tag_stripped="${tag#v}"
          if [ "$tag_stripped" != "$fw_version" ]; then
            echo "Release tag '$tag' must match firmware version 'v$fw_version'" >&2
            exit 1
          fi
          echo "fw_version=$fw_version" >> "$GITHUB_OUTPUT"

      - name: Clean workspace
        run: make clean

      - name: Build firmware
        env:
          CFLAGS: ${{ env.CFLAGS_EXTRA }}
          CPPFLAGS: ${{ env.CPPFLAGS_EXTRA }}
        run: |
          set -euo pipefail
          make -j"$(nproc)"
          ccache -s || true

      - name: Prepare release assets
        run: |
          set -euo pipefail
          if [ "${{ matrix.target }}" = "F303" ]; then
            project=H4
            dfuse_preset=stm32f303xc
          else
            project=H
            dfuse_preset=stm32f072xb
          fi
          fw_version='${{ steps.version.outputs.fw_version }}'
          dist_dir=dist
          mkdir -p "$dist_dir"
          base_name="NanoVNA-X_${{ matrix.target }}_v${fw_version}"
          for ext in bin hex; do
            cp "build/${project}.${ext}" "$dist_dir/${base_name}.${ext}"
          done
          dfu_path="$dist_dir/${base_name}.dfu"
          python3 tools/makedfu.py \
            "build/${project}.bin" \
            "$dfu_path" \
            --preset-target "$dfuse_preset" \
            --device-id 0x0000
          if command -v dfu-suffix >/dev/null 2>&1; then
            dfu-suffix --check "$dfu_path"
          fi
          for ext in bin hex dfu; do
            sha_file="$dist_dir/${base_name}.${ext}.sha256"
            sha256sum "$dist_dir/${base_name}.${ext}" > "$sha_file"
          done

      - name: Upload assets to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            dist/NanoVNA-X_${{ matrix.target }}_v${{ steps.version.outputs.fw_version }}.bin
            dist/NanoVNA-X_${{ matrix.target }}_v${{ steps.version.outputs.fw_version }}.hex
            dist/NanoVNA-X_${{ matrix.target }}_v${{ steps.version.outputs.fw_version }}.dfu
            dist/NanoVNA-X_${{ matrix.target }}_v${{ steps.version.outputs.fw_version }}.bin.sha256
            dist/NanoVNA-X_${{ matrix.target }}_v${{ steps.version.outputs.fw_version }}.hex.sha256
            dist/NanoVNA-X_${{ matrix.target }}_v${{ steps.version.outputs.fw_version }}.dfu.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Backoff before saving caches
        if: always()
        shell: bash
        run: |
          sleep $((RANDOM % 5 + 1))s

      - name: Save build cache
        if: success()
        uses: actions/cache/save@v4
        with:
          path: build
          key: build-${{ env.OSNAME }}-${{ matrix.target }}-${{ steps.gccver.outputs.ver }}-${{ hashFiles('Makefile','config/**','boards/**','include/**','src/**','tools/**') }}-${{ github.run_id }}-${{ github.run_attempt }}

      - name: Save ccache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.CCACHEDIR }}
          key: ccache-${{ env.OSNAME }}-${{ matrix.target }}-${{ steps.gccver.outputs.ver }}-${{ hashFiles('Makefile','config/**','boards/**','include/**','src/**','tools/**') }}-${{ github.run_id }}-${{ github.run_attempt }}

name: Release firmware

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  upload:
    name: Release (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [ F072, F303 ]

    env:
      TARGET: ${{ matrix.target }}
      APT_PACKAGES: "dfu-util python3"
      OS_NAME: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Cache APT
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt
            /var/lib/apt/lists
          key: apt-${{ env.OS_NAME }}-${{ env.APT_PACKAGES }}
          restore-keys: |
            apt-${{ env.OS_NAME }}-

      - name: Install runtime tools
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends ${APT_PACKAGES}

      - name: Determine firmware version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          fwversion="$(make -s print-version)"
          if ! printf "%s" "$fwversion" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z\.-]+)?$'; then
            echo "Firmware version '$fwversion' is not semantic" >&2
            exit 1
          fi
          tag="${{ github.event.release.tag_name }}"
          tag_stripped="${tag#v}"
          if [[ "$tag_stripped" != "$fwversion" ]]; then
            echo "Release tag '$tag' must match firmware version 'v$fwversion'" >&2
            exit 1
          fi
          echo "fwversion=$fwversion" >> "$GITHUB_OUTPUT"

      - name: Download CI artifacts
        uses: actions/download-artifact@v4
        with:
          name: NanoVNA-X-${{ matrix.target }}
          path: dist

      - name: Ensure DFU present or generate
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ matrix.target }}" == "F303" ]]; then
            project="H4"
            dfuse_preset="stm32f303xc"
          else
            project="H"
            dfuse_preset="stm32f072xb"
          fi
          if [[ ! -f "dist/${project}.dfu" ]]; then
            if [[ -f "dist/${project}.bin" ]]; then
              python3 tools/makedfu.py "dist/${project}.bin" "dist/${project}.dfu" --preset-target "${dfuse_preset}" --device-id 0x0000
              dfu-suffix --check "dist/${project}.dfu"
            else
              echo "Missing dist/${project}.bin to generate DFU" >&2
              exit 1
            fi
          fi

      - name: Prepare release assets
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ matrix.target }}" == "F303" ]]; then
            project="H4"
          else
            project="H"
          fi
          fwversion="${{ steps.version.outputs.fwversion }}"
          base="NanoVNA-X-${{ matrix.target }}-v${fwversion}"
          mkdir -p dist/release
          cp "dist/${project}.bin" "dist/release/${base}.bin"
          cp "dist/${project}.hex" "dist/release/${base}.hex"
          cp "dist/${project}.dfu" "dist/release/${base}.dfu"
          for ext in bin hex dfu; do
            sha256sum "dist/release/${base}.${ext}" > "dist/release/${base}.${ext}.sha256"
          done
          echo "base=${base}" >> "$GITHUB_OUTPUT"

      - name: Upload assets to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            dist/release/${{ steps.prep.outputs.base }}.bin
            dist/release/${{ steps.prep.outputs.base }}.hex
            dist/release/${{ steps.prep.outputs.base }}.dfu
            dist/release/${{ steps.prep.outputs.base }}.bin.sha256
            dist/release/${{ steps.prep.outputs.base }}.hex.sha256
            dist/release/${{ steps.prep.outputs.base }}.dfu.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
